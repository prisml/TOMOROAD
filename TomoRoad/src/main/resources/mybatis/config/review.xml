<?xml version="1.0" encoding="UTF-8"?>
<!-- Sql Mapper -->
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="review">
	<resultMap type="reviewVO" id="reviewRM">
		<result property="postedTime" column="posted_time" />
		<result property="place.no" column="place_no" />
		<result property="member.id" column="member_id" />
	</resultMap>
	<resultMap type="reviewVO" id="detailReviewRM" extends="reviewRM">
		<result column="name" property="place.name"/>
		<result column="station_name" property="place.station_name"/>
	</resultMap>
	<select id="getTotalContents" resultType="int">
		select count(*) from
		review
	</select>
	<select id="getList" resultType="reviewVO" resultMap="detailReviewRM"
		parameterType="pagingBean">
		select A.*
		from(select row_number() over(order by r.no desc) rnum, 
			r.no, r.title, r.member_id, r.place_no, p.name, r.hits,
			to_char(posted_time,'YYYY/MM/DD HH24:MM') as posted_time 
			from review r, place p where r.place_no = p.no)	A 
		where rnum between #{startRowNumber} and #{endRowNumber}
	</select>
	<insert id="register" parameterType="reviewVO">
		<selectKey keyProperty="no" resultType="int" order="BEFORE">
			select
			review_seq.nextval from dual
		</selectKey>
		insert into
		review(no,title,content,posted_time,star,place_no,member_id)
		values(#{no},#{title},#{content},sysdate,#{star},#{place.no},#{member.id})
	</insert>
	<select id="detail" resultMap="detailReviewRM">
		select
		r.no,r.title,r.content,r.posted_time,r.star,r.place_no,r.member_id,r.hits,p.name from review r, place p where
		r.no=#{value} and r.place_no=p.no
	</select>
	<update id="update" parameterType="reviewVO">
		update review set
		title=#{title}, content=#{content}, star=#{star}, place_no=#{place.no}
		where no=#{no}
	</update>
	<update id="updateHits">
		update review set hits=hits+1 where no=#{value}
	</update>
	<select id="getListByMember" resultType="reviewVO" resultMap="reviewRM">
		select A.*
		from(select row_number() over(order by r.no desc) rnum, 
			r.no, r.title, r.member_id, r.place_no, p.name, r.hits,
			to_char(posted_time,'YYYY/MM/DD HH24:MM') as posted_time 
			from review r, place p where r.place_no = p.no)	A 
		where rnum between #{startRowNumber} and #{endRowNumber} and member_id={id}
	</select>
	<select id="getListByPlace" resultType="reviewVO" resultMap="reviewRM">		
		select A.*
		from(select row_number() over(order by r.no desc) rnum, 
			r.no, r.title, r.member_id, r.place_no, p.name, r.hits,
			to_char(posted_time,'YYYY/MM/DD HH24:MM') as posted_time 
			from review r, place p where r.place_no = p.no)	A 
		where rnum between #{startRowNumber} and #{endRowNumber} and place_no={place}
	</select>
	<delete id="delete">
		delete from review where no=#{no}
	</delete>
</mapper>